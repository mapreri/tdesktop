Description: Eliminates dependencies from static Qt
Author: Nicholas Guriev <guriev-ns@ya.ru>
Bug-Debian: https://bugs.debian.org/767418
Bug-Ubuntu: https://launchpad.net/bugs/1499516
Last-Update: 2016-06-17

--- telegram-desktop-0.9.51.orig/Telegram/SourceFiles/main.cpp
+++ telegram-desktop-0.9.51/Telegram/SourceFiles/main.cpp
@@ -25,10 +25,6 @@ Copyright (c) 2014-2016 John Preston, ht
 #include "localstorage.h"
 
 int main(int argc, char *argv[]) {
-#ifndef Q_OS_MAC // Retina display support is working fine, others are not.
-	QCoreApplication::setAttribute(Qt::AA_DisableHighDpiScaling, true);
-#endif // Q_OS_MAC
-
 	settingsParseArgs(argc, argv);
 	if (cLaunchMode() == LaunchModeFixPrevious) {
 		return psFixPrevious();
--- telegram-desktop-0.9.51.orig/Telegram/SourceFiles/profile/profile_widget.cpp
+++ telegram-desktop-0.9.51/Telegram/SourceFiles/profile/profile_widget.cpp
@@ -128,7 +128,7 @@ void Widget::onScroll() {
 	auto windowHandle = window()->windowHandle();
 	auto globalPoint = QCursor::pos();
 	auto localPoint = windowHandle->mapFromGlobal(globalPoint);
-	QMouseEvent ev(QEvent::MouseMove, localPoint, localPoint, globalPoint, Qt::NoButton, QGuiApplication::mouseButtons(), QGuiApplication::keyboardModifiers(), Qt::MouseEventSynthesizedByApplication);
+	QMouseEvent ev(QEvent::MouseMove, localPoint, localPoint, globalPoint, Qt::NoButton, QGuiApplication::mouseButtons(), QGuiApplication::keyboardModifiers());
 	ev.setTimestamp(getms());
 
 	QGuiApplication::sendEvent(windowHandle, &ev);
--- telegram-desktop-0.9.51.orig/Telegram/SourceFiles/stdafx.cpp
+++ telegram-desktop-0.9.51/Telegram/SourceFiles/stdafx.cpp
@@ -18,6 +18,8 @@ to link the code of portions of this pro
 Full license: https://github.com/telegramdesktop/tdesktop/blob/master/LICENSE
 Copyright (c) 2014-2016 John Preston, https://desktop.telegram.org
 */
+#if 0
+
 #include "stdafx.h"
 #include <QtCore/QtPlugin>
 
@@ -43,3 +45,5 @@ Q_IMPORT_PLUGIN(QIbusPlatformInputContex
 Q_IMPORT_PLUGIN(QFcitxPlatformInputContextPlugin)
 Q_IMPORT_PLUGIN(QWebpPlugin)
 #endif
+
+#endif
--- telegram-desktop-0.9.51.orig/Telegram/SourceFiles/stdafx.h
+++ telegram-desktop-0.9.51/Telegram/SourceFiles/stdafx.h
@@ -22,10 +22,10 @@ Copyright (c) 2014-2016 John Preston, ht
 #define NOMINMAX // no min() and max() macro declarations
 #define __HUGE
 
-// Fix Google Breakpad build for Mac App Store version
-#ifdef Q_OS_MAC
+// Fix Google Breakpad build for Mac App Store version and for Linux Ubuntu
+#if defined Q_OS_MAC || defined Q_OS_LINUX
 #define __STDC_FORMAT_MACROS
-#endif // Q_OS_MAC
+#endif // Q_OS_MAC || Q_OS_LINUX
 
 #ifdef __cplusplus
 
--- telegram-desktop-0.9.51.orig/Telegram/SourceFiles/ui/text/text.cpp
+++ telegram-desktop-0.9.51/Telegram/SourceFiles/ui/text/text.cpp
@@ -30,6 +30,43 @@ Copyright (c) 2014-2016 John Preston, ht
 #include "boxes/confirmbox.h"
 #include "mainwindow.h"
 
+// This is a copy from Qt source file qtextengine.cpp for TextPainter::drawLine.
+// Temporary fix it here.
+// TODO: find a dynamic library which contains this methods.
+QTextItemInt::QTextItemInt(const QGlyphLayout &g, QFont *font, const QChar *chars_, int numChars, QFontEngine *fe, const QTextCharFormat &format)
+    : flags(0), justified(false), underlineStyle(QTextCharFormat::NoUnderline), charFormat(format),
+      num_chars(numChars), chars(chars_), logClusters(0), f(font),  glyphs(g), fontEngine(fe)
+{
+}
+
+// Fix up flags and underlineStyle with given info
+void QTextItemInt::initWithScriptItem(const QScriptItem &si)
+{
+    // explicitly initialize flags so that initFontAttributes can be called
+    // multiple times on the same TextItem
+    flags = 0;
+    if (si.analysis.bidiLevel %2)
+        flags |= QTextItem::RightToLeft;
+    ascent = si.ascent;
+    descent = si.descent;
+
+    if (charFormat.hasProperty(QTextFormat::TextUnderlineStyle)) {
+        underlineStyle = charFormat.underlineStyle();
+    } else if (charFormat.boolProperty(QTextFormat::FontUnderline)
+               || f->d->underline) {
+        underlineStyle = QTextCharFormat::SingleUnderline;
+    }
+
+    // compat
+    if (underlineStyle == QTextCharFormat::SingleUnderline)
+        flags |= QTextItem::Underline;
+
+    if (f->d->overline || charFormat.fontOverline())
+        flags |= QTextItem::Overline;
+    if (f->d->strikeOut || charFormat.fontStrikeOut())
+        flags |= QTextItem::StrikeOut;
+}
+
 namespace {
 
 const style::textStyle *_textStyle = nullptr;
--- telegram-desktop-0.9.51.orig/Telegram/SourceFiles/ui/text/text_block.cpp
+++ telegram-desktop-0.9.51/Telegram/SourceFiles/ui/text/text_block.cpp
@@ -333,7 +333,7 @@ TextBlock::TextBlock(const style::font &
 		QStackTextEngine engine(part, blockFont->f);
 		engine.itemize();
 
-		QTextLayout layout(&engine);
+		QTextLayout layout(part, blockFont->f);
 		layout.beginLayout();
 		layout.createLine();
 
--- telegram-desktop-0.9.51.orig/Telegram/Telegram.pro
+++ telegram-desktop-0.9.51/Telegram/Telegram.pro
@@ -1,6 +1,9 @@
 QT += core gui network widgets
 
-CONFIG += plugin static c++11
+CONFIG += plugin c++14
+
+DEFINES += TDESKTOP_DISABLE_AUTOUPDATE
+DEFINES += TDESKTOP_DISABLE_REGISTER_CUSTOM_SCHEME
 
 CONFIG(debug, debug|release) {
     DEFINES += _DEBUG
@@ -10,7 +13,6 @@ CONFIG(debug, debug|release) {
     DESTDIR = ./../Debug
 }
 CONFIG(release, debug|release) {
-    DEFINES += CUSTOM_API_ID
     OBJECTS_DIR = ./../ReleaseIntermediate
     MOC_DIR = ./GeneratedFiles/Release
     RCC_DIR = ./GeneratedFiles
@@ -47,7 +49,20 @@ codegen_lang.target = lang_target
 codegen_lang.depends = ./../../Telegram/Resources/langs/lang.strings
 codegen_lang.commands = mkdir -p ./GeneratedFiles && ./../DebugLang/MetaLang -lang_in ./../../Telegram/Resources/langs/lang.strings -lang_out ./GeneratedFiles/lang_auto
 
-QMAKE_EXTRA_TARGETS += codegen_style codegen_numbers codegen_lang
+fix_style_basic.target = GeneratedFiles/styles/style_basic.cpp
+fix_style_basic.depends = style_target
+fix_style_basic_types.target = GeneratedFiles/styles/style_basic_types.cpp
+fix_style_basic_types.depends = style_target
+fix_style_overview.target = GeneratedFiles/styles/style_overview.cpp
+fix_style_overview.depends = style_target
+fix_style_dialogs.target = GeneratedFiles/styles/style_dialogs.cpp
+fix_style_dialogs.depends = style_target
+fix_style_history.target = GeneratedFiles/styles/style_history.cpp
+fix_style_history.depends = style_target
+fix_style_profile.target = GeneratedFiles/styles/style_profile.cpp
+fix_style_profile.depends = style_target
+
+QMAKE_EXTRA_TARGETS += codegen_style codegen_numbers codegen_lang fix_style_basic fix_style_basic_types fix_style_overview fix_style_dialogs fix_style_history fix_style_profile
 
 PRE_TARGETDEPS += style_target numbers_target lang_target
 
@@ -385,10 +400,6 @@ HEADERS += \
   ./SourceFiles/pspecific_mac.h
 }
 
-SOURCES += \
-  ./ThirdParty/minizip/zip.c \
-  ./ThirdParty/minizip/ioapi.c
-
 CONFIG += precompile_header
 
 PRECOMPILED_HEADER = ./SourceFiles/stdafx.h
@@ -400,7 +411,7 @@ CONFIG(release, debug|release) {
     QMAKE_CXXFLAGS_RELEASE -= -O2
     QMAKE_CXXFLAGS_RELEASE += -Ofast -flto -fno-strict-aliasing -g
     QMAKE_LFLAGS_RELEASE -= -O1
-    QMAKE_LFLAGS_RELEASE += -Ofast -flto -g -rdynamic -static-libstdc++
+    QMAKE_LFLAGS_RELEASE += -Ofast -flto -g -rdynamic
 }
 # Linux 32bit fails Release link with Link-Time Optimization: virtual memory exhausted
 unix {
@@ -412,20 +423,19 @@ unix {
     }
 }
 CONFIG(debug, debug|release) {
-	QMAKE_LFLAGS_DEBUG += -g -rdynamic -static-libstdc++
+	QMAKE_LFLAGS_DEBUG += -g -rdynamic
 }
 
 include(qt_static.pri)
 
-INCLUDEPATH += \
-               /usr/local/include\
-               /usr/local/include/opus\
-               ./SourceFiles\
-               ./GeneratedFiles\
-               ./ThirdParty/minizip\
-               ./../../Libraries/breakpad/src
+INCLUDEPATH += "./SourceFiles" \
+               "./GeneratedFiles"
 
+INCLUDEPATH += "/usr/include"
+INCLUDEPATH += "/usr/include/opus"
+INCLUDEPATH += "/usr/include/breakpad"
 INCLUDEPATH += "/usr/include/libappindicator-0.1"
+INCLUDEPATH += "/usr/include/libappindicator3-0.1"
 INCLUDEPATH += "/usr/include/gtk-2.0"
 INCLUDEPATH += "/usr/include/glib-2.0"
 INCLUDEPATH += "/usr/lib/x86_64-linux-gnu/glib-2.0/include"
@@ -436,17 +446,15 @@ INCLUDEPATH += "/usr/lib/x86_64-linux-gn
 INCLUDEPATH += "/usr/lib/i386-linux-gnu/gtk-2.0/include"
 INCLUDEPATH += "/usr/include/gdk-pixbuf-2.0"
 INCLUDEPATH += "/usr/include/atk-1.0"
-
 INCLUDEPATH += "/usr/include/dee-1.0"
 INCLUDEPATH += "/usr/include/libdbusmenu-glib-0.4"
+INCLUDEPATH += "/usr/include/minizip"
 
 LIBS += -ldl -llzma -lopenal -lavformat -lavcodec -lswresample -lswscale -lavutil -lopus -lva
-LIBS += $${QT_TDESKTOP_PATH}/plugins/platforminputcontexts/libcomposeplatforminputcontextplugin.a \
-        $${QT_TDESKTOP_PATH}/plugins/platforminputcontexts/libibusplatforminputcontextplugin.a \
-        $${QT_TDESKTOP_PATH}/plugins/platforminputcontexts/libfcitxplatforminputcontextplugin.a
-LIBS += /usr/local/lib/libz.a
-LIBS += /usr/local/lib/libxkbcommon.a
-LIBS += ./../../../Libraries/breakpad/src/client/linux/libbreakpad_client.a
+LIBS += -lz
+LIBS += -lminizip
+LIBS += -lbreakpad_client
+LIBS += -lcrypto -lssl
 
 RESOURCES += \
     ./Resources/telegram.qrc \
--- telegram-desktop-0.9.51.orig/Telegram/qt_static.pri
+++ telegram-desktop-0.9.51/Telegram/qt_static.pri
@@ -14,7 +14,6 @@ isEmpty(QT_TDESKTOP_VERSION) {
     QT_TDESKTOP_VERSION = $${QT_TDESKTOP_VERSION_DEFAULT}
 }
 
-INCLUDEPATH += $${QT_TDESKTOP_PATH}/include/QtGui/$${QT_TDESKTOP_VERSION}/QtGui \
-               $${QT_TDESKTOP_PATH}/include/QtCore/$${QT_TDESKTOP_VERSION}/QtCore \
-               $${QT_TDESKTOP_PATH}/include
-
+INCLUDEPATH += "/usr/include/$$(DEB_HOST_MULTIARCH)/qt5/QtGui/$${QT_TDESKTOP_VERSION}/QtGui" \
+               "/usr/include/$$(DEB_HOST_MULTIARCH)/qt5/QtCore/$${QT_TDESKTOP_VERSION}/QtCore" \
+               "/usr/include/$$(DEB_HOST_MULTIARCH)/qt5" \
